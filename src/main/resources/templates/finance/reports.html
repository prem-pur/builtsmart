<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reports - BuildSmart CMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/manager-dashboard.css" rel="stylesheet">
</head>
<body>
    <div class="app">
        <div th:replace="~{fragments/sidebar :: financeSidebar(user=${user}, activePage='reports')}"></div>
        <main class="stack">
            <div class="card">
                <div>
                    <h4 class="mb-1"><i class="fas fa-chart-bar me-2"></i>Financial Reports & Analytics</h4>
                    <p class="text-muted mb-0">Comprehensive financial overview and statistics</p>
                </div>
            </div>

            <!-- Expense Statistics -->
            <div class="card">
                <div class="section-title">
                    <h5><i class="fas fa-receipt me-1"></i> Expense Summary</h5>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Total Expenses</div>
                                    <div class="stat-value">LKR <span th:text="${#numbers.formatDecimal(totalExpenses, 0, 'COMMA', 2, 'POINT')}">0</span></div>
                                </div>
                                <div class="stat-icon primary">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Pending</div>
                                    <div class="stat-value" th:text="${pendingExpensesCount}">0</div>
                                </div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Approved</div>
                                    <div class="stat-value" th:text="${approvedExpensesCount}">0</div>
                                </div>
                                <div class="stat-icon info">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Paid</div>
                                    <div class="stat-value" th:text="${paidExpensesCount}">0</div>
                                </div>
                                <div class="stat-icon success">
                                    <i class="fas fa-money-check"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses by Category -->
            <div class="card">
                <div class="section-title">
                    <h5><i class="fas fa-chart-pie me-1"></i> Expenses by Category</h5>
                </div>
                <div class="row g-3">
                    <div th:if="${#maps.isEmpty(expensesByCategory)}" class="col-12">
                        <p class="text-muted text-center">No expense data available</p>
                    </div>
                    <div th:each="entry : ${expensesByCategory}" class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span th:text="${entry.key}">Category</span>
                            <strong>LKR <span th:text="${#numbers.formatDecimal(entry.value, 0, 'COMMA', 2, 'POINT')}">0</span></strong>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-primary" 
                                 role="progressbar"
                                 th:style="'width: ' + ${categoryPercentages.get(entry.key)} + '%'"
                                 th:text="${categoryPercentages.get(entry.key)} + '%'">
                                0%
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget & Financial Overview -->
            <div class="card">
                <div class="section-title">
                    <h5><i class="fas fa-wallet me-1"></i> Budget & Financial Overview</h5>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Total Budget</div>
                                    <div class="stat-value">LKR <span th:text="${#numbers.formatDecimal(totalBudget, 0, 'COMMA', 2, 'POINT')}">0</span></div>
                                </div>
                                <div class="stat-icon success">
                                    <i class="fas fa-wallet"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Utilized</div>
                                    <div class="stat-value">LKR <span th:text="${#numbers.formatDecimal(totalUtilized, 0, 'COMMA', 2, 'POINT')}">0</span></div>
                                </div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Remaining</div>
                                    <div class="stat-value">LKR <span th:text="${#numbers.formatDecimal(totalBudget.subtract(totalUtilized), 0, 'COMMA', 2, 'POINT')}">0</span></div>
                                </div>
                                <div class="stat-icon info">
                                    <i class="fas fa-piggy-bank"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3" th:if="${totalBudget != null && totalBudget.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-semibold">Overall Budget Utilization</span>
                        <strong th:text="${budgetUtilizationPercentage + '%'}">0%</strong>
                    </div>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar" 
                             th:classappend="${budgetUtilizationPercentage >= 90 ? ' bg-danger' : budgetUtilizationPercentage >= 75 ? ' bg-warning' : ' bg-success'}"
                             role="progressbar"
                             th:style="'width: ' + ${budgetUtilizationPercentage} + '%'"
                             th:text="${budgetUtilizationPercentage + '%'}">
                            0%
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Financial Health:</strong> 
                    <span th:if="${totalBudget != null && totalBudget.compareTo(T(java.math.BigDecimal).ZERO) > 0 && budgetUtilizationPercentage >= 90}">
                        Budget utilization is over 90%. Consider reviewing project expenses.
                    </span>
                    <span th:if="${totalBudget != null && totalBudget.compareTo(T(java.math.BigDecimal).ZERO) > 0 && budgetUtilizationPercentage >= 75 && budgetUtilizationPercentage < 90}">
                        Budget utilization is between 75-90%. Monitor expenses closely.
                    </span>
                    <span th:if="${totalBudget != null && totalBudget.compareTo(T(java.math.BigDecimal).ZERO) > 0 && budgetUtilizationPercentage < 75}">
                        Budget utilization is healthy. Continue monitoring expenses.
                    </span>
                    <span th:if="${totalBudget == null || totalBudget.compareTo(T(java.math.BigDecimal).ZERO) <= 0}">
                        No budget data available.
                    </span>
                </div>
            </div>

            <!-- Payment Reminders -->
            <div class="card">
                <div class="section-title">
                    <h5><i class="fas fa-bell me-1"></i> Payment Reminders Summary</h5>
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Pending Reminders</div>
                                    <div class="stat-value" th:text="${pendingRemindersCount}">0</div>
                                </div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Overdue</div>
                                    <div class="stat-value" th:text="${overdueRemindersCount}">0</div>
                                </div>
                                <div class="stat-icon danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stat-label">Pending Amount</div>
                                    <div class="stat-value">LKR <span th:text="${#numbers.formatDecimal(totalPendingPayments, 0, 'COMMA', 2, 'POINT')}">0</span></div>
                                </div>
                                <div class="stat-icon info">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="section-title">
                    <h5><i class="fas fa-bolt me-1"></i> Quick Actions</h5>
                </div>
                <div class="row g-2">
                    <div class="col-md-4">
                        <a href="/finance/expenses" class="btn btn-outline-primary w-100">
                            <i class="fas fa-receipt me-1"></i> View All Expenses
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/finance/reminders" class="btn btn-outline-warning w-100">
                            <i class="fas fa-bell me-1"></i> View Reminders
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/finance/expenses/new" class="btn btn-outline-success w-100">
                            <i class="fas fa-plus me-1"></i> Log New Expense
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
